
# Telegram-бот для запроса банковских реквизитов (ATME Bank Details Bot)

Этот бот предназначен для ускорения рутинных процессов операторов, предоставляя быстрый доступ к актуальным банковским реквизитам и подтверждающим документам, хранящимся в Google Spreadsheets и Google Drive.

## Основная Концепция

Бот работает только для пользователей, чьи Telegram ID внесены в **Список Доступа**. Он считывает актуальные реквизиты из Google Sheets по ключевому коду, записывает сделки и обновляет данные в Google Sheets.

##  Архитектура и Структура Сервисов

Проект построен на Node.js/TypeScript

| Сервис | Ответственность | Ключевой нюанс |
| :--- | :--- | :--- |
| **`*Controller`** | Обработка команд по типу `/bdetails xxx`. Оркестрирует работу сервисов. | - |
| **`*Service`** | Бизнес-логика: поиск, форматирование ответа, скачивание файла. Инкапсулирует логику работы с низкоуровневыми сервисами и провайдерами. | - |
| **`GoogleSheetsService`** | Низкоуровневый доступ к Google Sheets. | **КЭШИРУЕТ ТОЛЬКО МЕТАДАННЫЕ** (список листов) при старте (`initialize()`). Чтение строк данных всегда асинхронное (через `sheet.getRows()`). |
| **`GoogleDriveService`** | Скачивание файлов с Google Drive. | Скачивает файл по ссылке из таблицы во временное локальное хранилище (`tmp_files`) и удаляет его после отправки пользователю. Требует отдельной настройки прав. |

##  Настройка и Запуск

### 1\. Переменные Окружения (`.env`)

Для запуска проекта необходимо создать файл `.env` со следующими переменными:

| Переменная | Описание |
| :--- | :--- |
| `TELEGRAM_BOT_TOKEN` | Токен вашего Telegram бота. |
| `GOOGLE_SHEETS_SPREADSHEET_ID` | ID таблицы Google Sheets, где хранятся реквизиты. |
| `ACCESS_LIST` | Список Telegram ID, разделенных запятыми, которым разрешено использовать бота. |
| `GOOGLE_SERVICE_ACCOUNT_KEY_PATH` | **Путь** к JSON-файлу сервисной учетной записи (например, `./google-service-key.json`). |

### 2\. Ключевые файлы

  * `google-service-key.json`: Файл ключа сервисной учетной записи Google.

### 3\. Запуск

```bash
# Установка зависимостей
npm install

# Сборка проекта
npm run build

# Компиляция и запуск
npm run start:prod
```

##  Нюансы Работы с Google API

### 1\. Авторизация и Доступы 

Для корректной работы сервисной учетной записи (`api-test@...gserviceaccount.com`) и вашего приложения необходимо выполнить следующие шаги в Google Cloud Platform (GCP) и на уровне ресурсов:

#### Настройка Google Cloud Platform (GCP)

1.  **Создание и Конфигурация Проекта:** Необходимо создать новый проект в GCP или использовать существующий.
2.  **Активация API:** Внутри этого проекта должны быть активированы следующие сервисы (API), чтобы ваше приложение могло с ними взаимодействовать:
    * **Google Sheets API**
    * **Google Drive API**

####  Настройка Прав Доступа к Ресурсам

После того как API активированы, необходимо выдать разрешения самой сервисной учетной записи:

* **Google Sheets:** Предоставить права **Читателя** (Viewer) или **Редактора** к самой Google Таблице.
* **Файлы на Drive:** Для **каждого файла**-подтверждения (на который ссылается столбец `Filepath`), сервисной учетной записи должны быть явно предоставлены права **Читателя** (Viewer).

### 2\. Актуальность Данных

  * **Строки данных:** Сервисы гарантирует актуальность, вызывая сетевой запрос `sheet.getRows()` при **каждом** запросе пользователя.
  * **Новые листы/таблицы:** Если в Google Sheets были добавлены **новые листы** (метаданные), приложение их не увидит, так как метаданные кэшируются при старте. Для обновления метаданных требуется **перезапуск** приложения.
  * **Временное хранение:** Файлы, скачанные с Drive, временно хранятся в папке `./tmp_files` и **удаляются сразу** после отправки пользователю.

### 3\. Формат Таблицы Реквизитов

Таблицы должны содержать столбцы и заголовки, указанные в коде. Ключи чувствительны к регистру
